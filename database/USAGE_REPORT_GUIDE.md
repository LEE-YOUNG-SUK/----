# 📦 재료비 레포트 추가 완료 가이드

## ✅ 작업 완료 내역

### 새로 추가된 페이지
```
/reports/usage → 📦 재료비 레포트
```

---

## 📂 생성된 파일

### 1. **레포트 페이지**
- `app/reports/usage/page.tsx`
  - 서버 컴포넌트
  - 세션 검증
  - 권한 체크 (원장/매니저 이상)

### 2. **클라이언트 컴포넌트**
- `app/reports/usage/UsageReportClient.tsx`
  - 필터 관리
  - AG Grid 표시
  - 요약 카드

### 3. **Server Actions**
- `app/reports/usage/actions.ts`
  - `getUsageReport()` 함수
  - `transaction_type='USAGE'` 필터링
  - 클라이언트 측 그룹핑 및 집계

### 4. **네비게이션 메뉴**
- `components/shared/Navigation.tsx`
  - 레포트 드롭다운에 "📦 재료비" 추가

---

## 🎨 페이지 구조

### URL: `/reports/usage`

### 제목: 📦 재료비 레포트

### 설명
```
내부 사용(소모)된 재료비 현황을 조회합니다
```

---

## 📊 컬럼 구조

| 컬럼명 | 설명 | 스타일 |
|--------|------|--------|
| **구분** | 일별/월별/품목별 | Bold |
| **총 수량** | 사용된 총 수량 | 숫자 |
| **총 재료비** | FIFO 원가 합계 | Bold, 빨간색 |
| **평균 단가 (FIFO)** | 평균 원가 | 회색 |
| **사용 건수** | 거래 건수 | 숫자 |
| **품목 수** | 품목별 아닌 경우만 | 숫자 |

### ❌ 제외된 컬럼
- **총 이익**: 사용은 이익이 0이므로 표시하지 않음
- **고객**: 내부사용 고정이므로 표시하지 않음

---

## 📈 요약 카드

판매 레포트와 달리 **3개 카드만** 표시:

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 총 사용 건수    │  │ 총 사용 수량    │  │ 총 재료비       │
│ 280건           │  │ 1,450개         │  │ ₩3,500,000      │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

### 안내 메시지
```
💡 참고: 재료비는 FIFO 방식으로 계산된 평균 원가입니다. 
사용(내부소모)은 이익이 0이므로 이익 컬럼이 표시되지 않습니다.
```

---

## 🔄 데이터 조회 방식

### 방법 1: 직접 조회 (현재 구현)
```typescript
// sales 테이블에서 직접 조회
const { data } = await supabase
  .from('sales')
  .select('...')
  .eq('transaction_type', 'USAGE')
  .gte('sale_date', startDate)
  .lte('sale_date', endDate)
```

**장점**:
- ✅ 정확한 USAGE 데이터만 조회
- ✅ 새로운 RPC 함수 불필요

**단점**:
- ❌ 클라이언트 측 그룹핑 필요
- ❌ 서버 부하 가능성

### 방법 2: RPC 함수 활용 (권장, 향후 개선)
```sql
-- 새로운 RPC 함수 생성
CREATE OR REPLACE FUNCTION get_usage_report(
  p_user_role TEXT,
  p_branch_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_group_by TEXT
)
RETURNS TABLE (...)
AS $$
BEGIN
  -- get_sales_report와 유사하지만 transaction_type='USAGE' 필터 추가
END;
$$;
```

**장점**:
- ✅ 서버 측 집계 (성능 향상)
- ✅ 일관된 구조 (판매 레포트와 동일)

**단점**:
- ❌ DB 마이그레이션 필요

---

## 🎯 그룹핑 옵션

### 사용 가능
- ✅ **일별 (daily)**: 일자별 집계
- ✅ **월별 (monthly)**: 월별 집계
- ✅ **품목별 (product)**: 품목별 집계

### 사용 불가
- ❌ **고객별 (customer)**: 내부사용 고정이므로 의미 없음

---

## 🔐 권한

### 접근 가능한 역할
- ✅ 시스템 관리자 (0000): 전체 지점 조회
- ✅ 원장 (0001): 본인 지점 조회
- ✅ 매니저 (0002): 본인 지점 조회

### 접근 불가
- ❌ 사용자 (0003): 레포트 조회 권한 없음

---

## 🆚 판매 레포트 vs 재료비 레포트

| 항목 | 판매 레포트 | 재료비 레포트 |
|------|------------|--------------|
| **URL** | `/reports/sales` | `/reports/usage` |
| **아이콘** | 💰 | 📦 |
| **필터** | `transaction_type: 'SALE'` | `transaction_type: 'USAGE'` |
| **컬럼 수** | 7개 | 5개 |
| **이익 컬럼** | ✅ 있음 | ❌ 없음 |
| **고객 필터** | ✅ 가능 | ❌ 불가 |
| **그룹핑** | 일별/월별/품목별/고객별 | 일별/월별/품목별 |
| **요약 카드** | 5개 | 3개 |
| **주요 지표** | 매출, 이익 | 재료비 (원가) |

---

## 📋 네비게이션 메뉴 구조

```
레포트 ▼
  ├── 📊 구매
  ├── 💰 판매
  ├── 📦 재료비    ← 신규 추가!
  └── 📈 이익
```

---

## 🧪 테스트 시나리오

### 1. 접근 권한 테스트
- [ ] 원장/매니저로 로그인 → `/reports/usage` 접근 성공
- [ ] 사용자(0003)로 로그인 → 접근 거부 (리다이렉트)

### 2. 필터 테스트
- [ ] 기간 선택 → 해당 기간 데이터 조회
- [ ] 그룹핑 변경 (일별/월별/품목별) → 정상 작동
- [ ] 지점 선택 (관리자) → 해당 지점 데이터만 표시

### 3. 데이터 표시 테스트
- [ ] USAGE 거래만 표시되는지 확인
- [ ] 총 재료비 정확성 확인
- [ ] 요약 카드 정확성 확인
- [ ] 이익 컬럼이 표시되지 않는지 확인

### 4. 네비게이션 테스트
- [ ] 레포트 메뉴 → "📦 재료비" 클릭 → 페이지 이동

---

## 🎯 빌드 결과

```
Route (app)
├ ƒ /reports/sales     ← 판매 레포트
├ ƒ /reports/usage     ← 재료비 레포트 (신규!)
└ ƒ /reports/profit    ← 이익 레포트
```

**✅ 빌드 성공!** (TypeScript 에러 0개)

---

## 💡 향후 개선 사항

### 1. RPC 함수 최적화
```sql
-- 전용 RPC 함수 생성으로 성능 개선
CREATE FUNCTION get_usage_report(...)
```

### 2. 추가 필터
- 특정 품목 선택
- 사용 부서별 필터 (향후 확장)

### 3. 차트 추가
- 월별 재료비 추이 그래프
- 품목별 재료비 비율 파이 차트

---

## 📊 예상 활용 시나리오

### 1. 월별 재료비 분석
```
그룹핑: 월별
기간: 2024-01 ~ 2024-12
→ 월별 재료비 추이 파악
```

### 2. 품목별 소모 현황
```
그룹핑: 품목별
기간: 최근 1개월
→ 가장 많이 사용되는 품목 파악
```

### 3. 지점별 재료비 비교 (관리자)
```
지점: 전체
그룹핑: 월별
→ 지점별 재료비 효율성 비교
```

---

## 🎉 기대 효과

1. ✅ **재료비 가시성 향상**: 내부 소모 비용 명확히 파악
2. ✅ **비용 관리**: 품목별/월별 재료비 추이 분석 가능
3. ✅ **의사결정 지원**: 재료비 절감 방안 도출
4. ✅ **일관된 UI**: 판매 레포트와 동일한 구조
5. ✅ **권한 기반 접근**: 역할별 적절한 데이터 노출

---

**작업 완료일**: 2025-01-26  
**빌드 상태**: ✅ 성공  
**DB 변경**: ❌ 없음 (기존 sales 테이블 활용)  
**권한 변경**: ❌ 없음 (기존 reports_view 권한 활용)

